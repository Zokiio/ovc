# Ice4j Configuration for Hytale Voice Chat WebRTC SFU
# Based on official Ice4j reference: https://github.com/jitsi/ice4j/blob/master/src/main/resources/reference.conf
# This configuration requires ALL keys below to prevent ConfigException during Agent initialization

# Legacy org.ice4j naming convention (also supported)
org {
  ice4j {
    # ===== CONSENT FRESHNESS (RFC7675 - Consent Freshness Checks) =====
    ice {
      CONSENT_FRESHNESS_INTERVAL = 30000                          # ms between STUN Binding consent checks
      CONSENT_FRESHNESS_ORIGINAL_INTERVAL = 5000                  # ms initial back-off for first retransmission
      CONSENT_FRESHNESS_WAIT_INTERVAL = 5000                      # ms wait before first retransmission (alt naming)
      CONSENT_FRESHNESS_MAX_WAIT_INTERVAL = 10000                 # ms max wait between retransmissions
      CONSENT_FRESHNESS_MAX_RETRANSMISSIONS = 3                   # max retransmissions before consent fails
    }

    # ===== TERMINATION AND CHECK LIST =====
    TERMINATION_DELAY = 3000                                      # ms to wait after COMPLETED before TERMINATED
    MAX_CHECK_LIST_SIZE = 100                                     # max ICE candidate pairs per stream

    # ===== AGENT CONFIGURATION =====
    USE_COMPONENT_SOCKET = true                                  # use pooled socket from Component (recommended)
    REDACT_REMOTE_ADDRESSES = false                              # redact remote IPs in logs
    SOFTWARE = "ice4j.org"                                        # SOFTWARE attribute in STUN messages

    # ===== HARVEST CONFIGURATION =====
    ice {
      harvest {
        # Link-local and IPv6 addresses
        DISABLE_LINK_LOCAL_ADDRESSES = false                      # false = allow link-local (169.254.x.x)
        USE_IPV6 = true                                           # gather IPv6 candidates
        USE_DYNAMIC_HOST_HARVESTER = false                        # disable dynamic host harvester for SFU

        # UDP Harvesting
        HARVESTING_TIMEOUT = 15000                               # ms timeout for candidate gathering
        AbstractUdpListener.SO_RCVBUF = 0                        # 0 = use OS default, >0 = custom buffer size

        # Network Interfaces
        ALLOWED_INTERFACES = ""                                  # ";" sep list of allowed interfaces (empty=all)
        BLOCKED_INTERFACES = ""                                  # ";" sep list of blocked interfaces (empty=none)

        # IP Addresses
        ALLOWED_ADDRESSES = ""                                   # ";" sep list of allowed IPs (empty=all)
        BLOCKED_ADDRESSES = ""                                   # ";" sep list of blocked IPs (empty=none)

        # NAT Mapping Harvesters (static pre-configured mappings)
        NAT_HARVESTER_LOCAL_ADDRESS = ""                         # local IP for static mapping
        NAT_HARVESTER_PUBLIC_ADDRESS = ""                        # public IP for static mapping

        # STUN Mapping Harvesters (dynamic discovery via STUN)
        STUN_MAPPING_HARVESTER_ADDRESSES = ""                    # comma-sep STUN servers (empty=none)

        # AWS Harvester (EC2 metadata service)
        DISABLE_AWS_HARVESTER = true                             # true = disable AWS harvester
        FORCE_AWS_HARVESTER = false                              # false = only use if detected in AWS
      }
    }
  }
}

# Modern ice4j.* naming convention (Typesafe Config / HOCON)
ice4j {
  # ===== ICE CONFIGURATION =====
  ice {
    max-check-list-size = 100
    termination-delay = 3 seconds
  }

  # ===== AGENT CONFIGURATION =====
  software = "ice4j.org"
  redact-remote-addresses = false
  use-component-socket = true
  send-to-last-received-from-address = false                    # don't switch sending to last-received-from

  # ===== CONSENT FRESHNESS (RFC7675) =====
  consent-freshness {
    interval = 30 seconds                                        # 15s default, 30s recommended
    original-wait-interval = 500 milliseconds                    # initial back-off for retransmission
    max-wait-interval = 500 milliseconds                         # max wait between retransmissions
    max-retransmissions = 30                                     # max retransmissions before consent fails
    randomize-interval = true                                    # randomize Â±20% as per RFC7675 Section 5.1
  }

  # ===== HARVEST CONFIGURATION (Candidate Gathering) =====
  harvest {
    # IPv6 and Link-Local Configuration
    use-ipv6 = true                                              # gather IPv6 candidates
    use-link-local-addresses = true                              # gather link-local (169.254.x.x)
    timeout = 15 seconds                                         # timeout for harvester

    # UDP Configuration
    udp {
      use-dynamic-ports = true                                   # dynamic ephemeral ports (recommended for SFU)
      receive-buffer-size = 0                                    # 0 = OS default, >0 = custom SO_RCVBUF
      socket-pool-size = 0                                       # 0 = num processors, 1 = no pool
    }

    # Network Interface Management
    allowed-interfaces = []                                      # empty = allow all, else whitelist
    blocked-interfaces = []                                      # empty = block none, else blacklist

    # IP Address Management
    allowed-addresses = []                                       # empty = allow all, else whitelist
    blocked-addresses = []                                       # empty = block none, else blacklist

    # NAT Mapping Harvesters (pre-configured)
    mapping {
      static-mappings = [
        # Example (disabled):
        # { local-address = "10.0.0.1", local-port = 10000, public-address = "203.0.113.1", public-port = 20000 }
      ]

      # STUN Mapping Harvesters (dynamic discovery)
      stun {
        addresses = []                                           # STUN servers: ["stun.example.com:3478", ...]
      }

      # AWS Harvester (EC2 metadata service for NAT traversal)
      aws {
        enabled = false                                          # disable AWS harvester
        force = false                                            # false = only use if running in AWS
      }
    }
  }
}
